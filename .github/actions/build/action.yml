name: Build and Test
description: Runs build

runs:
  using: "composite"
  steps:
    - name: Install mise
      uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3
      env:
        MISE_FETCH_REMOTE_VERSIONS_TIMEOUT: 30s
      with:
        version: 2025.12.12
        github_token: ${{ steps.app-auth.outputs.token }}
        # only saving the cache in the prerequisites job
        cache_save: false
        install: false
    - run: mise plugin install https://github.com/pulumi/vfox-pulumi
      shell: bash
    - env:
        ESC_ACTION_ENVIRONMENT: github-secrets/${{ github.repository_owner }}-${{ github.event.repository.name }}
        ESC_ACTION_EXPORT_ENVIRONMENT_VARIABLES: "false"
        ESC_ACTION_OIDC_AUTH: "true"
        ESC_ACTION_OIDC_ORGANIZATION: pulumi
        ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
      id: esc-secrets
      name: Fetch secrets from ESC
      uses: pulumi/esc-action@9eb774255b1a4afb7855678ae8d4a77359da0d9b
    - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
      id: app-auth
      with:
        app-id: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_APP_ID }}
        private-key: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_PRIVATE_KEY }}
        owner: ${{ github.repository_owner }}
    - name: Setup mise
      uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3
      env:
        MISE_FETCH_REMOTE_VERSIONS_TIMEOUT: 30s
      with:
        version: 2025.12.12
        github_token: ${{ steps.app-auth.outputs.token }}
        # only saving the cache in the prerequisites job
        cache_save: true
    - name: Install packages
      shell: bash
      run: yarn install --frozen-lockfile
    - name: Run build
      shell: bash
      run: yarn run build
    - name: Check worktree clean
      uses: pulumi/git-status-check-action@v1
    - name: Run unit tests
      shell: bash
      run: yarn run test
